<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de Menus Nutritionnels</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et r√©actif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .line-through-text { text-decoration: line-through; color: #9ca3af; }
        /* Style sp√©cifique pour la fen√™tre de chat */
        #chat-interface {
            height: 60vh;
            min-height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-indigo-200 pb-2">Planificateur de Menus Hebdomadaires</h1>

        <!-- Affichage des messages flash (succ√®s ou erreur) -->
        <% if flash[:notice] %>
            <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg shadow-md" role="alert"><%= flash[:notice] %></div>
        <% end %>
        <% if flash[:alert] %>
            <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg shadow-md" role="alert"><%= flash[:alert] %></div>
        <% end %>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Section Chatbot (remplace le formulaire) -->
            <div id="chatbot-container" class="<%= @meal_plan ? 'lg:col-span-1' : 'lg:col-span-3' %> transition-all duration-300 bg-white p-6 rounded-2xl shadow-xl h-fit">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Assistant Nutritionnel IA</h2>

                <!-- Fen√™tre de conversation -->
                <div id="chat-interface" class="border border-gray-200 p-4 rounded-lg bg-gray-50 mb-4">
                    <!-- Messages ins√©r√©s ici par JS -->
                </div>

                <!-- Formulaire cach√© pour la soumission finale -->
                <%= form_with(model: @user_preference, url: meal_plans_generate_path, method: :post, data: { turbo: false }, class: "space-y-6 hidden", id: "final-submission-form") do |f| %>

                    <!-- Champs cach√©s qui seront remplis par JavaScript -->
                    <%= f.hidden_field :age, id: 'chat_age' %>
                    <%= f.hidden_field :gender, id: 'chat_gender' %>
                    <%= f.hidden_field :activity_level, id: 'chat_activity_level' %>
                    <%= f.hidden_field :weekly_budget_max, id: 'chat_weekly_budget_max' %>
                    <%= f.hidden_field :max_prep_time_minutes, id: 'chat_max_prep_time_minutes' %>
                    <%= f.hidden_field :allergies, id: 'chat_allergies' %>

                    <button type="submit" id="submit-button" class="w-full py-3 px-4 border border-transparent rounded-xl shadow-md text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        G√©n√©rer Mon Plan (Veuillez r√©pondre aux questions)
                    </button>
                <% end %>

                <!-- Interface de r√©ponse utilisateur -->
                <div id="user-input-area" class="mt-4">
                    <!-- Les champs de saisie dynamique (input, boutons, select) seront ins√©r√©s ici par JS -->
                </div>
            </div>

            <!-- Section Affichage du Plan de Repas G√©n√©r√© -->
            <% if @meal_plan %>
                <div id="plan-display" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Mon Plan de Menu (7 Jours)</h2>

                    <!-- Indicateur Nutritionnel et Budget (US05, US07) -->
                    <div class="mb-6 p-4 rounded-xl <%= @meal_plan[:macros_ok] ? 'bg-green-100 border-green-400' : 'bg-yellow-100 border-yellow-400' %> border-l-4 shadow-inner">
                        <h3 class="font-extrabold text-xl mb-2 text-gray-800">Bilan Hebdomadaire</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <p class="font-medium">
                                üî• Cible Calorique : **<%= @meal_plan[:user_kcal_target] %> kcal/jour**
                            </p>
                            <p class="font-medium">
                                üçΩ Estimation Plan : **<%= @meal_plan[:generated_kcal] %> kcal/jour**
                            </p>
                            <p class="font-medium <%= @meal_plan[:cost_ok] ? 'text-green-700' : 'text-red-700' %>">
                                üí∏ Budget Max : **<%= number_to_currency(@user_preference.weekly_budget_max, unit: "‚Ç¨", separator: ",", delimiter: " ") %>**
                            </p>
                            <p class="font-medium <%= @meal_plan[:cost_ok] ? 'text-green-700' : 'text-red-700' %>">
                                üí∞ Co√ªt Estim√© : **<%= number_to_currency(@meal_plan[:estimated_cost], unit: "‚Ç¨", separator: ",", delimiter: " ") %>**
                            </p>
                        </div>

                        <div class="h-2 w-full bg-gray-300 rounded-full mt-3">
                            <div class="h-2 rounded-full <%= @meal_plan[:macros_ok] ? 'bg-green-500' : 'bg-yellow-500' %>" style="width: 95%;"></div>
                            <span class="text-xs text-gray-600 mt-1 block text-center font-semibold">√âquilibre Macronutritionnel : Atteint (US05)</span>
                        </div>
                    </div>

                    <!-- Affichage du Plan Jour par Jour (US03) -->
                    <div class="space-y-6 max-h-[60vh] overflow-y-auto pr-2">
                        <% @meal_plan[:menus].each do |day, meals| %>
                            <div class="border-b border-indigo-100 pb-4">
                                <h3 class="text-xl font-bold text-indigo-700 mb-3 bg-indigo-50 p-2 rounded-lg shadow-sm"><%= day %></h3>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <% meals.each do |meal_type, recipe| %>
                                        <div class="p-4 bg-gray-50 rounded-xl shadow-md border border-gray-200">
                                            <p class="font-bold text-base text-gray-700 mb-1"><%= meal_type %> :</p>

                                            <!-- TITRE OK -->
                                            <p class="text-sm font-medium text-indigo-800 mb-1 leading-snug"><%= recipe['name'] %></p>
                                            <div class="text-xs text-gray-500 flex justify-between mt-2 pt-2 border-t border-gray-200">

                                                <!-- TEMPS OK -->
                                                <span>‚è± <%= recipe['preparation_time'] %> min</span>

                                                <!-- CORRECTION PRIX : Affiche N/A si la cl√© est absente -->
                                                <span>
                                                    üí∞
                                                    <% if recipe['cost'].present? %>
                                                        <%= number_to_currency(recipe['cost'], unit: "‚Ç¨", separator: ",", delimiter: " ") %>
                                                    <% else %>
                                                        N/A
                                                    <% end %>
                                                </span>

                                                <!-- CALORIES OK -->
                                                <span>üî• <%= recipe['kcal'] %> kcal</span>
                                            </div>
                                            <!-- Bouton de modification (US04) -->
                                            <button class="mt-2 text-xs text-indigo-500 hover:text-indigo-700 font-medium transition duration-150 ease-in-out underline" onclick="replaceRecipe('<%= day %>', '<%= meal_type %>', '<%= recipe['name'] %>')">
                                                Remplacer (US04)
                                            </button>
                                        </div>
                                    <% end %>
                                </div>
                            </div>
                        <% end %>
                    </div>

                    <!-- Bouton pour la liste de courses (US08) -->
                    <button id="show-shopping-list" class="mt-6 w-full py-3 px-4 border border-transparent rounded-xl shadow-md text-base font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        G√©n√©rer la Liste de Courses (US08)
                    </button>
                </div>
            <% if @meal_plan.present? %>
                <div id="plan-display-info" class="mt-4 p-4 rounded-xl shadow-md bg-white lg:col-span-3">
                    <h4 class="font-extrabold text-lg text-indigo-700 mb-2">R√©sum√© ZOE Health</h4>
                    <p class="text-sm text-gray-700"><%= @meal_plan[:diversity_summary] %></p>
                </div>
            <% end %>
        </div>
    </div>

    <script>
        // Fonctionnalit√©s d'assistance (non li√©es au chat)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        function replaceRecipe(day, meal, recipeName) {
            alert(`Fonctionnalit√© US04: Remplacer la recette "${recipeName}" du ${meal} de ${day}.`);
        }

        const modal = document.getElementById('shopping-list-modal');
        function closeModal() {
            modal.classList.add('hidden');
        }

        // G√®re le comportement de cocher/barrer pour la liste de courses (US09)
        function toggleStrike(listItem) {
            const span = listItem.querySelector('span');
            const checkbox = listItem.querySelector('input[type="checkbox"]');
            const isChecked = checkbox.checked = !checkbox.checked;

            if (isChecked) {
                span.classList.add('line-through-text');
                listItem.classList.add('bg-green-50', 'border-green-300');
                listItem.classList.remove('bg-white', 'border-gray-200');
            } else {
                span.classList.remove('line-through-text');
                listItem.classList.remove('bg-green-50', 'border-green-300');
                listItem.classList.add('bg-white', 'border-gray-200');
            }
        }

        // G√®re l'affichage de la modale de liste de courses
        const shoppingListButton = document.getElementById('show-shopping-list');
        const listContent = document.getElementById('shopping-list-content');

        if (shoppingListButton) {
            shoppingListButton.addEventListener('click', function() {
                // S'assurer que @meal_plan existe avant d'essayer de le parser
                if (<%= @meal_plan.present? %>) {
                    const mealPlanData = <%= @meal_plan.to_json.html_safe %>;
                    let allIngredients = {};

                    Object.values(mealPlanData.menus).forEach(day => {
                        Object.values(day).forEach(recipe => {
                            if (Array.isArray(recipe.ingredients)) {
                                recipe.ingredients.forEach(ing => {
                                    allIngredients[ing] = (allIngredients[ing] || 0) + 1;
                                });
                            }
                        });
                    });

                    listContent.innerHTML = Object.keys(allIngredients).map(ing => {
                        return `<li class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm cursor-pointer" onclick="toggleStrike(this)"><span class="text-gray-800 font-medium">${ing}</span><div class="flex items-center space-x-2 text-sm text-gray-500"><span>(utilis√© ${allIngredients[ing]} fois)</span><input type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 pointer-events-none"></div></li>`;
                    }).join('');
                }
                modal.classList.remove('hidden');
            });
        }

        // ===========================================
        // LOGIQUE CHATBOT
        // ===========================================

        const chatInterface = document.getElementById('chat-interface');
        const userInputArea = document.getElementById('user-input-area');
        const finalForm = document.getElementById('final-submission-form');

        let conversationState = 0;
        let userData = {
            age: null,
            gender: null,
            activity_level: null,
            weekly_budget_max: null,
            max_prep_time_minutes: null,
            allergies: []
        };

        const questions = [
            { id: 'age', text: "Bonjour ! Pour commencer, quel est votre √¢ge ?", type: 'number', min: 18, max: 100, field: 'age' },
            { id: 'gender', text: "Quel est votre genre ? (Homme, Femme, Autre)", type: 'select', options: ['homme', 'femme', 'autre'], field: 'gender' },
            { id: 'activity_level', text: "Quel est votre niveau d'activit√© physique habituel ? (S√©dentaire, Mod√©r√©, Actif)", type: 'select', options: ['s√©dentaire', 'mod√©r√©', 'actif'], field: 'activity_level' },
            { id: 'budget', text: "Quel est votre budget maximal approximatif pour les courses de la semaine (en ‚Ç¨) ?", type: 'number', min: 10, field: 'weekly_budget_max' },
            { id: 'prep_time', text: "Quel est le temps maximum (en minutes) que vous souhaitez consacrer √† la pr√©paration d'un seul repas ?", type: 'number', min: 5, field: 'max_prep_time_minutes' },
            { id: 'allergies', text: "Avez-vous des allergies ou intol√©rances sp√©cifiques √† exclure ? (S√©lectionnez tout ce qui s'applique, ou 'Aucune').", type: 'checkbox', options: ['Gluten', 'Lactose', 'Arachides', 'Poisson', '≈íufs', 'Aucune'], field: 'allergies' }
        ];

        function addMessage(sender, text, isHtml = false) {
            const senderClass = sender === 'bot'
                ? 'bg-indigo-100 text-indigo-800 self-start rounded-b-lg rounded-tr-lg'
                : 'bg-green-100 text-gray-800 self-end rounded-b-lg rounded-tl-lg';
            const messageDiv = document.createElement('div');
            messageDiv.className = `max-w-xs md:max-w-md my-2 p-3 shadow-md ${senderClass}`;
            if (isHtml) {
                messageDiv.innerHTML = text;
            } else {
                messageDiv.textContent = text;
            }
            chatInterface.appendChild(messageDiv);
            // D√©filement automatique
            chatInterface.scrollTop = chatInterface.scrollHeight;
        }

        function showQuestion(index) {
            userInputArea.innerHTML = ''; // Nettoyer la zone de saisie

            if (index >= questions.length) {
                finalizeConversation();
                return;
            }

            const question = questions[index];
            addMessage('bot', question.text);

            let inputElement;

            if (question.type === 'number' || question.type === 'text') {
                inputElement = `
                    <input type="${question.type}" id="current-input" class="w-full p-3 border rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="${question.type === 'number' ? 'Entrez un nombre' : 'Tapez votre r√©ponse'}" ${question.min ? `min="${question.min}"` : ''} ${question.max ? `max="${question.max}"` : ''}>
                    <button onclick="handleAnswer('${question.field}')" class="mt-2 w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">Valider</button>
                `;
                userInputArea.innerHTML = inputElement;
            } else if (question.type === 'select') {
                inputElement = question.options.map(option => `
                    <button onclick="handleAnswer('${question.field}', '${option}')" class="m-1 py-2 px-4 border border-indigo-300 rounded-full bg-white text-indigo-700 hover:bg-indigo-50 transition">${option}</button>
                `).join('');
                userInputArea.innerHTML = `<div class="flex flex-wrap">${inputElement}</div>`;
            } else if (question.type === 'checkbox') {
                 // Pour les allergies, on utilise la m√©thode d'envoi du formulaire final
                 inputElement = question.options.map(option => `
                    <label class="inline-flex items-center m-1 p-2 border border-gray-300 rounded-lg cursor-pointer">
                        <input type="checkbox" name="allergy_option" value="${option}" class="h-4 w-4 text-indigo-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">${option}</span>
                    </label>
                 `).join('');

                 userInputArea.innerHTML = `
                    <div class="flex flex-wrap border p-3 rounded-lg bg-white">${inputElement}</div>
                    <button onclick="handleAllergiesAnswer('${question.field}')" class="mt-2 w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">Continuer</button>
                 `;
            }
        }

        function handleAnswer(field, fixedValue = null) {
            let answer = fixedValue;

            if (fixedValue === null) {
                const input = document.getElementById('current-input');
                answer = input.value;
                if (!answer || (questions[conversationState].type === 'number' && isNaN(parseInt(answer)))) {
                    alert("Veuillez entrer une valeur valide.");
                    return;
                }
            }

            userData[field] = answer;
            addMessage('user', answer);
            conversationState++;
            showQuestion(conversationState);
        }

        function handleAllergiesAnswer(field) {
            const checkboxes = document.querySelectorAll('input[name="allergy_option"]:checked');
            let allergies = Array.from(checkboxes).map(cb => cb.value);

            if (allergies.includes('Aucune')) {
                allergies = ['']; // Laisser vide pour la soumission Rails
            } else if (allergies.length === 0) {
                 allergies = [''];
            } else {
                // Retirer 'Aucune' si d'autres allergies sont s√©lectionn√©es
                allergies = allergies.filter(a => a !== 'Aucune');
            }

            userData[field] = allergies;

            const displayList = allergies.length > 0 && allergies[0] !== '' ? allergies.join(', ') : 'Aucune allergie sp√©cifi√©e.';
            addMessage('user', displayList);

            conversationState++;
            showQuestion(conversationState);
        }

        function finalizeConversation() {
            userInputArea.innerHTML = '';
            addMessage('bot', "Parfait ! J'ai toutes les informations n√©cessaires. Je vais maintenant g√©n√©rer votre plan de menu.");

            // Remplir les champs cach√©s du formulaire Rails
            document.getElementById('chat_age').value = userData.age;
            document.getElementById('chat_gender').value = userData.gender;
            document.getElementById('chat_activity_level').value = userData.activity_level;
            document.getElementById('chat_weekly_budget_max').value = userData.weekly_budget_max;
            document.getElementById('chat_max_prep_time_minutes').value = userData.max_prep_time_minutes;
            // IMPORTANT : Convertir le tableau d'allergies en cha√Æne s√©par√©e par des virgules pour le contr√¥leur
            document.getElementById('chat_allergies').value = userData.allergies.join(',');

            // Afficher le bouton de soumission
            finalForm.classList.remove('hidden');
            document.getElementById('submit-button').textContent = "G√©n√©rer Mon Plan Maintenant !";
        }

        // Initialisation du chatbot
        window.onload = () => {
            if (!<%= @meal_plan.present? %>) {
                showQuestion(conversationState);
            } else {
                // Si le plan est d√©j√† g√©n√©r√© (apr√®s soumission), on affiche un message
                addMessage('bot', "Votre plan a √©t√© g√©n√©r√©. Pour en cr√©er un nouveau, modifiez vos crit√®res ci-dessous et lancez la g√©n√©ration.");

                // Rendre le formulaire de soumission visible pour relancer la conversation
                finalForm.classList.remove('hidden');
                document.getElementById('submit-button').textContent = "G√©n√©rer un Nouveau Plan";
            }
             // G√®re l'affichage des ingr√©dients pour la liste de courses
            const shoppingListButton = document.getElementById('show-shopping-list');
            const listContent = document.getElementById('shopping-list-content');
            if (shoppingListButton) {
                shoppingListButton.addEventListener('click', function() {
                    // S'assurer que @meal_plan existe avant d'essayer de le parser
                    if (<%= @meal_plan.present? %>) {
                        const mealPlanData = <%= @meal_plan.to_json.html_safe %>;
                        let allIngredients = {};

                        Object.values(mealPlanData.menus).forEach(day => {
                            Object.values(day).forEach(recipe => {
                                if (Array.isArray(recipe.ingredients)) {
                                    recipe.ingredients.forEach(ing => {
                                        allIngredients[ing] = (allIngredients[ing] || 0) + 1;
                                    });
                                }
                            });
                        });

                        listContent.innerHTML = Object.keys(allIngredients).map(ing => {
                            return `<li class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm cursor-pointer" onclick="toggleStrike(this)"><span class="text-gray-800 font-medium">${ing}</span><div class="flex items-center space-x-2 text-sm text-gray-500"><span>(utilis√© ${allIngredients[ing]} fois)</span><input type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 pointer-events-none"></div></li>`;
                        }).join('');
                    }
                    modal.classList.remove('hidden');
                });
            }
        };

        // G√®re les √©v√©nements clavier (pour les inputs texte/nombre)
        userInputArea.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('current-input');
                if (input) {
                    e.preventDefault(); // Emp√™cher la soumission du formulaire
                    handleAnswer(questions[conversationState].field);
                }
            }
        });

    </script>
</body>
</html>
